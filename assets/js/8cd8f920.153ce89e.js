"use strict";(self.webpackChunkstarcoin_cookbook=self.webpackChunkstarcoin_cookbook||[]).push([[4054],{3905:function(e,n,t){t.d(n,{Zo:function(){return u},kt:function(){return m}});var a=t(7294);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?r(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function c(e,n){if(null==e)return{};var t,a,o=function(e,n){if(null==e)return{};var t,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var i=a.createContext({}),l=function(e){var n=a.useContext(i),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},u=function(e){var n=l(e.components);return a.createElement(i.Provider,{value:n},e.children)},p={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},d=a.forwardRef((function(e,n){var t=e.components,o=e.mdxType,r=e.originalType,i=e.parentName,u=c(e,["components","mdxType","originalType","parentName"]),d=l(t),m=o,h=d["".concat(i,".").concat(m)]||d[m]||p[m]||r;return t?a.createElement(h,s(s({ref:n},u),{},{components:t})):a.createElement(h,s({ref:n},u))}));function m(e,n){var t=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var r=t.length,s=new Array(r);s[0]=d;var c={};for(var i in n)hasOwnProperty.call(n,i)&&(c[i]=n[i]);c.originalType=e,c.mdxType="string"==typeof e?e:o,s[1]=c;for(var l=2;l<r;l++)s[l]=t[l];return a.createElement.apply(null,s)}return a.createElement.apply(null,t)}d.displayName="MDXCreateElement"},5962:function(e,n,t){t.r(n),t.d(n,{assets:function(){return i},contentTitle:function(){return s},default:function(){return p},frontMatter:function(){return r},metadata:function(){return c},toc:function(){return l}});var a=t(3117),o=(t(7294),t(3905));const r={},s="StarcoinReact Fastest Guild",c={unversionedId:"web3/starcoin-react-stepby",id:"web3/starcoin-react-stepby",title:"StarcoinReact Fastest Guild",description:"Take you from entry to advanced in one hour",source:"@site/docs/04-web3/07-starcoin-react-stepby.md",sourceDirName:"04-web3",slug:"/web3/starcoin-react-stepby",permalink:"/docs/web3/starcoin-react-stepby",draft:!1,editUrl:"https://github.com/starcoinorg/starcoin-cookbook/edit/main/docs/04-web3/07-starcoin-react-stepby.md",tags:[],version:"current",sidebarPosition:7,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Interaction with the chain by RPC and SDK",permalink:"/docs/web3/interacting-with-the-chain"},next:{title:"Reference",permalink:"/docs/reference/"}},i={},l=[{value:"Prepared",id:"prepared",level:2},{value:"Step 1 - The Basic",id:"step-1---the-basic",level:2},{value:"Download starmask-wallet",id:"download-starmask-wallet",level:3},{value:"Get test tokens",id:"get-test-tokens",level:3},{value:"Step 2 - The FrontEnd of Dapp",id:"step-2---the-frontend-of-dapp",level:2},{value:"Init Project",id:"init-project",level:3},{value:"Step 3 - communication with contract",id:"step-3---communication-with-contract",level:2},{value:"NFT",id:"nft",level:3},{value:"Step 4 - The Move Contract",id:"step-4---the-move-contract",level:2},{value:"Move Contract Project",id:"move-contract-project",level:3},{value:"Call Contract",id:"call-contract",level:3},{value:"Step 5 - Game Advanced",id:"step-5---game-advanced",level:2},{value:"Step 6 - Test Case",id:"step-6---test-case",level:2},{value:"Refinement plan",id:"refinement-plan",level:2}],u={toc:l};function p(e){let{components:n,...t}=e;return(0,o.kt)("wrapper",(0,a.Z)({},u,t,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"starcoinreact-fastest-guild"},"StarcoinReact Fastest Guild"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Take you from entry to advanced in one hour")),(0,o.kt)("h2",{id:"prepared"},"Prepared"),(0,o.kt)("p",null,"If you have programming experience is enough, if you have React, Rust, Move experience will be better. Programming is a hands-on craft, the key is action."),(0,o.kt)("h2",{id:"step-1---the-basic"},"Step 1 - The Basic"),(0,o.kt)("h3",{id:"download-starmask-wallet"},"Download starmask-wallet"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://starcoin.org/en/individual/#wallets"},"https://starcoin.org/en/individual/#wallets")),(0,o.kt)("p",null,"Now the wallet is the key to enter the blockchain, so preparing a wallet is a must. We want to use starcoin, then we need to use starcoin wallet. According to the wallet wizard, use the mnemonic to enter the wallet. Then switch the network to the barnard test network. Under the test network, we can receive tokens for free."),(0,o.kt)("h3",{id:"get-test-tokens"},"Get test tokens"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://faucet.starcoin.org/barnard"},"https://faucet.starcoin.org/barnard")),(0,o.kt)("p",null,"After the wallet is downloaded, go to this address to receive test coins. After receiving, the received STC will be displayed in the wallet in about 5 seconds. Now you can add an account to your wallet and transfer money between your two accounts. Make a perceptual understanding of the blockchain."),(0,o.kt)("h2",{id:"step-2---the-frontend-of-dapp"},"Step 2 - The FrontEnd of Dapp"),(0,o.kt)("p",null,"Let's start with the front end, and use JS to get accounts, balances, signatures, etc."),(0,o.kt)("h3",{id:"init-project"},"Init Project"),(0,o.kt)("p",null,"Use JS to call wallet basic functions"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"yarn create react-app starcoin-dapp --template typescript ")),(0,o.kt)("p",null,"Will CRA with webpack 5 build in now\uff0csome polyfill have removed from webpack 5 \uff0cso we need inject with ",(0,o.kt)("inlineCode",{parentName:"p"},"react-app-rewired")," \uff0c Specific visible warehouse in ",(0,o.kt)("inlineCode",{parentName:"p"},"package.json"),"\u3002"),(0,o.kt)("p",null,"After copying the official code, it feels very similar to eth, so the code has been modified."),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"init starcoinProvider")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'// App.tsx\n...\nlet starcoinProvider = new providers.Web3Provider(\n    (window as any).starcoin,\n    "any"\n  );\n  starcoinProvider.on("network", (newNetwork, oldNetwork) => {\n    // When a Provider makes its initial connection, it emits a "network"\n    // event with a null oldNetwork along with the newNetwork. So, if the\n    // oldNetwork exists, it represents a changing network\n    console.log({ newNetwork, oldNetwork });\n    if (oldNetwork) {\n      console.log("reload");\n      window.location.reload();\n    }\n  });\n')),(0,o.kt)("p",null,"This starcoinProvider is actually a wrapper for ",(0,o.kt)("inlineCode",{parentName:"p"},"(window as any).starcoin"),", for the convenience of writing programs."),(0,o.kt)("ol",{start:2},(0,o.kt)("li",{parentName:"ol"},"Use ",(0,o.kt)("inlineCode",{parentName:"li"},"starcoinProvider")," to get the public information of the wallet account:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'// App.tsx\n...\n  const onClickConnect = async () => {\n    try {\n      // const newAccounts = await (window as any).starcoin.request({\n      //   method: "stc_requestAccounts",\n      // });\n      // console.log(newAccounts);\n      // handleNewAccounts(newAccounts)\n      const network = await starcoinProvider.getNetwork();\n      console.log(network);\n      const result = await starcoinProvider.send("stc_requestAccounts", []);\n      console.log(result);\n      console.log(BigInt(10 ** 9));\n      let balance = await starcoinProvider.getBalance(result[0]);\n      if (balance)\n        console.log(\n          { balance },\n          (BigInt(balance.valueOf()) / BigInt(10 ** 9)).toString()\n        );\n      const blockNumber = await starcoinProvider.getBlockNumber();\n      console.log({ blockNumber });\n    } catch (error) {\n      console.error(error);\n    }\n  };\n')),(0,o.kt)("p",null,"In this way, the address of the wallet and the balance of the wallet are obtained."),(0,o.kt)("ol",{start:3},(0,o.kt)("li",{parentName:"ol"},"msg signing using ",(0,o.kt)("inlineCode",{parentName:"li"},"starcoinProvider"))),(0,o.kt)("p",null,"Nowadays, many web3 websites use wallet signatures to log in users, and they mainly use the msg signature signature function."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'// App.tsx\n...\n  const personalSign = async () => {\n    const exampleMessage = "Example `personal_sign` message \u4e2d\u6587";\n    try {\n      // personalSignResult.innerHTML = \'\'\n      // personalSignVerify.disabled = false\n      // personalSignRecoverResult.innerHTML = \'\'\n      const result = await starcoinProvider.send("stc_requestAccounts", []);\n      const from = result[0];\n      const msg = `0x${Buffer.from(exampleMessage, "utf8").toString("hex")}`;\n      // console.log({ msg })\n      // const networkId = networkDiv.innerHTML\n      const network = await starcoinProvider.getNetwork();\n      console.log(network);\n      const extraParams = { networkId: network.chainId };\n      const sign = await (window as any).starcoin.request({\n        method: "personal_sign",\n        // params: [msg, from, \'Example password\'],\n        // extraParams = params[2] || {}; means it should be an object:\n        // params: [msg, from, { pwd: \'Example password\' }],\n        params: [msg, from, extraParams],\n      });\n      console.log(sign);\n      // personalSignResult.innerHTML = sign\n    } catch (err) {\n      console.error(err);\n      // personalSign.innerHTML = `Error: ${ err.message }`\n    }\n  };\n  ...\n    const personalSignVerify = async () => {\n    try {\n      const accounts = await starcoinProvider.send("stc_requestAccounts", []);\n      const from = accounts[0];\n      const sign = "\u6362\u6210\u4e0a\u9762\u7684\u7b7e\u540d\u7ed3\u679c";\n      const recoveredAddr =\n        await utils.signedMessage.recoverSignedMessageAddress(sign);\n      console.log({ recoveredAddr, from });\n\n      // if (recoveredAddr === from) {\n      //   console.log(\n      //     `@starcoin/starcoin Successfully verified signer as ${recoveredAddr}`\n      //   );\n      //   personalSignRecoverResult.innerHTML = recoveredAddr;\n      // } else {\n      //   console.log("@starcoin/starcoin Failed to verify signer");\n      // }\n    } catch (err) {\n      console.error(err);\n      // personalSignRecoverResult.innerHTML = `Error: ${err.message}`;\n    }\n  };\n')),(0,o.kt)("p",null,"These are the basic functions that wallets often use."),(0,o.kt)("h2",{id:"step-3---communication-with-contract"},"Step 3 - communication with contract"),(0,o.kt)("p",null,"call contract use javascript."),(0,o.kt)("h3",{id:"nft"},"NFT"),(0,o.kt)("p",null,"To play the hottest NFT at the moment, prepare the description information of the NFT first"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'...\nconst nft = { \n    name: "test_nft",\n    imageUrl: "https://arweave.net/QeSUFwff9xDbl4SCXlOmEn0TuS4vPg11r2_ETPPu_nk",\n    description: "test nft desc",\n  }\n...\n')),(0,o.kt)("p",null,"The image address can be any address that can be accessed on the network. Then call the contract. Here is the official SimpleNFT"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'...\nconst nft = { \n    name: "test_nft",\n    imageUrl: "https://arweave.net/QeSUFwff9xDbl4SCXlOmEn0TuS4vPg11r2_ETPPu_nk",\n    description: "test nft desc",\n  }\n...\n')),(0,o.kt)("p",null,"\u56fe\u7247\u5730\u5740\u53ef\u4ee5\u662f\u7f51\u7edc\u4e0a\u4efb\u610f\u4e00\u5f20\u53ef\u4ee5\u8bbf\u95ee\u5230\u7684\u5730\u5740\u3002\u7136\u540e\u8c03\u53d6\u5408\u7ea6\u3002\u8fd9\u91cc\u9009\u7528\u5b98\u65b9\u7684 SimpleNFT"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"// App.tsx\n  const mintWithImageUrl = async () => {\n    // nftResult.innerHTML = 'Calling mintWithImage'\n    // mintWithImage.disabled = true\n    try {\n      const network = await starcoinProvider.getNetwork();\n      console.log(network);\n      // const extraParams = { networkId: network.chainId };\n\n      const functionId =\n        \"0x2c5bd5fb513108d4557107e09c51656c::SimpleNFTScripts::mint_with_image\";\n      const tyArgs: any[] = [];\n      const args = [nft.name, nft.imageUrl, nft.description];\n\n      const chainId = `${network.chainId}` as keyof typeof nodeUrlMap;\n      if (!nodeUrlMap[chainId]) return;\n\n      const nodeUrl = nodeUrlMap[chainId];\n      console.log({ functionId, tyArgs, args, nodeUrl });\n\n      const scriptFunction = await utils.tx.encodeScriptFunctionByResolve(\n        functionId,\n        tyArgs,\n        args,\n        nodeUrl\n      );\n\n      const payloadInHex = (function () {\n        const se = new bcs.BcsSerializer();\n        scriptFunction.serialize(se);\n        return hexlify(se.getBytes());\n      })();\n      console.log({ payloadInHex });\n\n      const txParams = {\n        data: payloadInHex,\n      };\n\n      const transactionHash = await starcoinProvider\n        .getSigner()\n        .sendUncheckedTransaction(txParams);\n      console.log({ transactionHash });\n      // nftResult.innerHTML = 'Call mintWithImage Completed'\n      // mintWithImage.disabled = false\n    } catch (error) {\n      // nftResult.innerHTML = 'Call mintWithImage Failed'\n      // mintWithImage.disabled = false\n      throw error;\n    }\n  };\n")),(0,o.kt)("p",null,"Later, you will be able to see your NFT in your starcoin wallet."),(0,o.kt)("p",null,"If you've used HTTP to get backend interfaces, this code will feel familiar. Yes, calling a contract is like calling an interface. In a way they are the same, but the backend is decentralized."),(0,o.kt)("h2",{id:"step-4---the-move-contract"},"Step 4 - The Move Contract"),(0,o.kt)("p",null,"First connect to the Barnard test network. ",(0,o.kt)("em",{parentName:"p"},"Many follow the tutorial to open the node locally, which is only suitable for understanding some commands. If you want to play, you still have to go to the test network"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"> starcoin --connect ws://barnard.seed.starcoin.org:9870 --local-account-dir ~/.starcoin/barnard/account_vaults console\n")),(0,o.kt)("p",null,"more about RPC info can be found here\uff1a ",(0,o.kt)("a",{parentName:"p",href:"https://starcoinorg.github.io/starcoin-cookbook/docs/getting-started/setup/test-network/"},"https://starcoinorg.github.io/starcoin-cookbook/docs/getting-started/setup/test-network/")),(0,o.kt)("p",null,"Then create an account, you can add the -p parameter to set the password."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'> starcoin% account create \n\n> starcoin% account list\n{\n  "ok": [\n    {\n        ...\n')),(0,o.kt)("p",null,"After the account is complete, you can go to ",(0,o.kt)("a",{parentName:"p",href:"https://faucet.starcoin.org/barnard"},"https://faucet.starcoin.org/barnard")," to receive some test coins, which is required for deploy contracts."),(0,o.kt)("h3",{id:"move-contract-project"},"Move Contract Project"),(0,o.kt)("p",null,"Prepare the command line tools first. ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/starcoinorg/starcoin/releases/tag/v1.11.13"},"https://github.com/starcoinorg/starcoin/releases/tag/v1.11.13")," Download the appropriate command line tool here."),(0,o.kt)("p",null,"create new move project"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"> mpm package new starcoin-contract\n")),(0,o.kt)("p",null,"you can copy the counter demo code here: ",(0,o.kt)("a",{parentName:"p",href:"https://starcoinorg.github.io/starcoin-cookbook/docs/move/deploy-first-move-contract/"},"https://starcoinorg.github.io/starcoin-cookbook/docs/move/deploy-first-move-contract/")),(0,o.kt)("p",null,"build the project"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"> mpm release\n")),(0,o.kt)("p",null,"deploy the project"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"> mpm deploy --rpc ws://barnard.seed.starcoin.org:9870 --local-account-dir  ~/.starcoin/barnard/account_vaults ~/HelloWorld/starcoin-contract/release/my_counter.v0.0.1.blob        \nUse package address (0xb80660f71e0d5ac2b5d5c43f2246403f) as transaction sender\nNo password given, use empty String.\ntxn 0x1d9b69f5fe765897875689b52df7f4807ca663b073bfcea9a763c3948ebeddb4 submitted.\nThe deployment is successful.\n")),(0,o.kt)("p",null,"This makes the deployment successful. Then you can communicate with the contract. Just like the previous NFT."),(0,o.kt)("h3",{id:"call-contract"},"Call Contract"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Write the contract")),(0,o.kt)("p",null,"Replace the functionId below with your deployed contract. You can have fun."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'// App.tsx\n...\n const initCounterStruct = async () => {\n    const accounts = await starcoinProvider.send("stc_requestAccounts", []);\n    console.log(accounts);\n    const network = await starcoinProvider.getNetwork();\n    console.log(network);\n    const chainId = `${network.chainId}` as keyof typeof nodeUrlMap;\n    if (!nodeUrlMap[chainId]) return;\n    const nodeUrl = nodeUrlMap[chainId];\n    const token = "0x00000000000000000000000000000001::STC::STC";\n    const functionId =\n      "0xb80660f71e0d5ac2b5d5c43f2246403f::RockPaperScissorsV6::init_counter";\n    const tyArgs: any[] = [token];\n    const args: any = [];\n    const scriptFunction = await utils.tx.encodeScriptFunctionByResolve(\n      functionId,\n      tyArgs,\n      args,\n      nodeUrl\n    );\n\n    const payloadInHex = (function () {\n      const se = new bcs.BcsSerializer();\n      scriptFunction.serialize(se);\n      return hexlify(se.getBytes());\n    })();\n    console.log({ payloadInHex });\n\n    const txParams = {\n      data: payloadInHex,\n    };\n\n    const transactionHash = await starcoinProvider\n      .getSigner()\n      .sendUncheckedTransaction(txParams);\n    console.log({ transactionHash });\n  };\n')),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Read the contract")),(0,o.kt)("p",null,"The above call is a write operation, and then query to see the effect:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'// App.tsx\n...\n  const getCounterStruct = async () => {\n    const accounts = await starcoinProvider.send("stc_requestAccounts", []);\n    console.log(accounts);\n    const data = await starcoinProvider.getResource(\n      accounts[0],\n      `0xb80660f71e0d5ac2b5d5c43f2246403f::RockPaperScissorsV6::Counter`\n    );\n    console.log(data);\n    const result = await (window as any).starcoin.request({\n      method: "state.get_resource",\n      params: [\n        accounts[0],\n        "0xb80660f71e0d5ac2b5d5c43f2246403f::RockPaperScissorsV6::Counter",\n      ],\n    });\n    console.log(result);\n    // const data = new bcs.BcsDeserializer(\n    //   arrayify(result.raw)\n    // ).de();\n    const de = new bcs.BcsDeserializer(arrayify(result.raw));\n    const name = de.deserializeStr();\n    const value = de.deserializeU8();\n    const timestamp = de.deserializeU64();\n    const input = Number(timestamp);\n    console.log(name, input);\n    console.log({\n      name: Buffer.from(name).toString(),\n      value,\n      timestamp: new Date(Number(timestamp) * 1000).toLocaleString(),\n    });\n  };\n')),(0,o.kt)("p",null,"In this code, I have added other fields except value. This involves parsing the bsc structure. specific documentation: ",(0,o.kt)("a",{parentName:"p",href:"https://starcoinorg.github.io/starcoin-cookbook/docs/web3/understanding-resource-and-bcs/bcs/"},"https://starcoinorg.github.io/starcoin-cookbook/docs/web3/understanding-resource-and-bcs/bcs/")),(0,o.kt)("p",null,"This parsing is in the order of the fields defined by ",(0,o.kt)("strong",{parentName:"p"},"Move")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"  const de = new bcs.BcsDeserializer(arrayify(result.raw));\n  const name = de.deserializeStr();\n  const value = de.deserializeU8();\n  const timestamp = de.deserializeU64();\n")),(0,o.kt)("p",null,"with"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-rust"},"...\n  struct Counter has key, store, drop {\n      name: vector<u8>,\n      value: u8,\n      timestamp: u64,\n      addr: address,\n  }\n...\n")),(0,o.kt)("p",null,"Here the last addr of the ",(0,o.kt)("inlineCode",{parentName:"p"},"Counter")," structure is address. Now it needs to be resolved with ",(0,o.kt)("inlineCode",{parentName:"p"},"const addr = AccountAddress.deserialize(de);"),", but you may already have the ",(0,o.kt)("inlineCode",{parentName:"p"},"de.deserializeAccountAddress();")," method when you are learning."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Delete from contract")),(0,o.kt)("p",null,"To delete is to remove ",(0,o.kt)("inlineCode",{parentName:"p"},"Counter")," from the user account. This operation is the biggest improvement of web3.0 compared to web2.0. That is, no one can delete it except the user himself. If the contract allows other people to delete it, then such a contract is not played. It's like someone else can take your money at will."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-rust"},"// Counter.move\n...\n  struct Counter has key, store, drop {\n    name: vector<u8>,\n    value: u8,\n    timestamp: u64,\n    addr: address,\n  }\n  ...\n  public(script) fun remove_counter(account: signer) acquires Counter {\n    move_from<Counter>(Signer::address_of(&account));\n  }\n...\n")),(0,o.kt)("p",null,"Deletion is like above in Move. In JS it is called the same as before."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"// Counter.tsx\n...\n  const removeCounter = useCallback(async () => {\n    const functionId = `${ContractModule}::remove_counter`;\n    const tyArgs: any[] = [];\n    const args: any = [];\n\n    await sendTx(functionId, tyArgs, args);\n  }, [sendTx]);\n...\n")),(0,o.kt)("p",null,"At this point, you have finished getting started. Yes, it's getting started. Next, use a SicBoGame to show how to advance."),(0,o.kt)("h2",{id:"step-5---game-advanced"},"Step 5 - Game Advanced"),(0,o.kt)("p",null,"The specific issue of SicBoGame comes from ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/starcoinorg/dapps/issues/9"},"https://github.com/starcoinorg/dapps/issues/9")," . That is, because it is impossible to bet at the same time, the contract needs to hide the information of the first bet. But the information of the blockchain is public, how to hide it? Issues9 also gives a method, that is, sha3 processing, and then compare in the contract. Large numbers, to prevent collisions. In this example code, we don't use this large number."),(0,o.kt)("p",null,"Create a new SicBo.move file, define Bank and Game"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-rust"}," struct Bank<phantom T: store> has store, key {\n    bank: Token::Token<T>\n  }\n\n  struct Game has key, store, drop {\n      aliceSecret: vector<u8>,\n      bobNum: u8,\n      aliceNum: u8,\n      timestamp: u64,\n      amount: u128,\n      campRaw: vector<u8>,\n      camp: vector<u8>,\n      aliceWin: bool,\n      bobWin: bool\n  }\n")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"Token::Token<T>")," cannot be ",(0,o.kt)("inlineCode",{parentName:"p"},"drop"),", so it cannot be held by Game like this"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-rust"},"  struct Game has key, store, drop {\n    aliceSecret: vector<u8>,\n    bobNum: u8,\n    aliceNum: u8,\n    timestamp: u64,\n    ..\n    bank: Token::Token<T>\n  }\n")),(0,o.kt)("p",null,"In this way, the Game cannot be deleted, and one person can only play one game. We hope that after a game is over, the next game can be started."),(0,o.kt)("p",null,"Then initialize Back This is the same as in the sample code, the difference is the command to initialize the bank."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-rust"},"  /// @admin init bank\n  public(script) fun init_bank<TokenType: store>(signer: signer, amount: u128) {\n      let account = &signer;\n      let signer_addr = Signer::address_of(account);\n\n      assert!(signer_addr == @admin, 10003);\n      assert!(! exists<Bank<TokenType>>(signer_addr), 10004);\n      assert!(Account::balance<TokenType>(signer_addr) >= amount, 10005);\n\n      let token = Account::withdraw<TokenType>(account, amount);\n      move_to(account, Bank<TokenType>{\n          bank: token\n      });\n\n      // move_to(account, BankEvent<TokenType>{\n      //     check_event: Event::new_event_handle<CheckEvent>(account),\n      // });\n  }\n")),(0,o.kt)("p",null,"Since we set admin as the contract owner, here we use the command line to initialize the bank."),(0,o.kt)("p",null,"Use the starcoin command line tool to enter the console"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"$ starcoin --connect ws://barnard.seed.starcoin.org:9870 --local-account-dir ~/.starcoin/barnard/account_vaults console\n")),(0,o.kt)("p",null,"and then exec"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"starcoin% starcoin% account execute-function --function 0xb80660f71e0d5ac2b5d5c43f2246403f::SicBo::init_bank -t 0x00000000000000000000000000000001::STC::STC --arg 0u128 -b\n")),(0,o.kt)("p",null,"The ",(0,o.kt)("em",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"em"},"u128"))," in ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"--arg 0u128")," is important because I initially got an argument error using ",(0,o.kt)("inlineCode",{parentName:"strong"},"--arg 0"),". Because the contract specifies that the amount is u128, the u128 suffix is also required to indicate the type. ")),(0,o.kt)("p",null,"If the command returns ",(0,o.kt)("inlineCode",{parentName:"p"},"account 0xb80660f71e0d5ac2b5d5c43f2246403f is locked"),", the account is locked and you need to unlock the account ",(0,o.kt)("inlineCode",{parentName:"p"},"starcoin% account unlock"),". Then call the command again. Get ",(0,o.kt)("inlineCode",{parentName:"p"},"txn 0x14bc2406c4967194fcb2b47a03a6404117bac24ebee6cf25d3c05b2fe7e65fd5 submitted.")," similar information, it means that our deployment has been adopted by the blockchain. After a while, you will get a bunch of post-execution returns. At this point the bank has been initialized, and we need to initialize the Game."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-rust"},"// SicBo.move\n...\n    public(script) fun init_game<TokenType: store>(alice: signer, aliceSecret: vector<u8>, amount: u128) acquires Bank {\n        let account = &alice;\n\n        let token = Account::withdraw<TokenType>(account, amount);\n        let bank = borrow_global_mut<Bank<TokenType>>(@admin);\n        Token::deposit<TokenType>(&mut bank.bank, token);\n\n        // init Game\n        move_to(account, Game {\n            aliceSecret: aliceSecret,\n            bobNum: 0,\n            aliceNum: 0,\n            timestamp: Timestamp::now_seconds(),\n            amount: amount,\n            campRaw: Vector::empty(),\n            camp: Vector::empty(),\n            aliceWin: false,\n            bobWin: false,\n        });\n    }\n")),(0,o.kt)("p",null,"The parameters to initialize Game are alice's encrypted information and alice's bet amount. A lot of the information here is what I use for debugging, ",(0,o.kt)("strong",{parentName:"p"},"a better way to debug move is unit testing"),". The default guess for alice and bob is 0 . Then 0 should not be used as a betting number, it can be 1-10."),(0,o.kt)("p",null,"After alice initializes the game, bob takes alice's address to participate in alice's game."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-rust"},"  public(script) fun bob_what<TokenType: store>(bob: signer, alice: address, bobNum: u8, amount: u128) acquires Game, Bank {\n        let account = &bob;\n\n        let token = Account::withdraw<TokenType>(account, amount);\n        let bank = borrow_global_mut<Bank<TokenType>>(@admin);\n        Token::deposit<TokenType>(&mut bank.bank, token);\n\n        let game = borrow_global_mut<Game>(alice);\n        game.bobNum = bobNum;\n        game.amount = game.amount + amount;\n        // TODO \n        // game.bobAddr = account\n    }\n\n")),(0,o.kt)("p",null,"When bob finishes betting, alice decrypts his bet. If alice does not decipher his bet, it is directly judged that alice has lost."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-rust"},"...\n    public(script) fun alice_what<TokenType: store>(alice: signer, aliceNum: u8) acquires Game {\n        let account = &alice;\n        // let token = Account::withdraw<TokenType>(account, amount);\n\n        let game = borrow_global_mut<Game>(Signer::address_of(account));\n        game.aliceNum = aliceNum;\n\n        // check valid\n        let tmpVec = Vector::empty();\n        let tempCamp = Vector::empty();\n\n        let addr = Signer::address_of(account);\n        Vector::append(&mut tmpVec, BCS::to_bytes(&addr));\n        Vector::append(&mut tmpVec, BCS::to_bytes(&aliceNum));\n        \n        Vector::append(&mut tempCamp, BCS::to_bytes(&addr));\n        Vector::append(&mut tempCamp, BCS::to_bytes(&aliceNum));\n        \n        game.campRaw = tmpVec;\n        let camp = Hash::sha3_256(tempCamp);\n        game.camp = camp;\n        \n\n        if (&game.camp == &game.aliceSecret) {\n            if (game.aliceNum > game.bobNum) {\n              game.aliceWin = true;\n              win_token(game.aliceAddr, game.amount);\n            } else if (game.aliceNum < game.bobNum) {\n              game.bobWin = true;  \n              win_token(game.bobWin, game.amount);\n            } else {\n              game.aliceWin = true;\n              game.bobWin = true;  \n              win_token(game.bobWin, game.amount / 2);\n              win_token(game.bobWin, game.amount / 2);\n            }\n        } else {\n            game.bobWin = true;\n            win_token(game.bobWin, game.amount);\n        }\n\n        // Game over, drop\n        move_from<Game>(game.aliceAddr);\n    }\n\n    fun win_token<TokenType: store>(account: address, amount: u128) acquires Bank {\n        let bank = borrow_global_mut<Bank<TokenType>>(@admin);\n        let token = Token::withdraw<TokenType>(&mut bank.bank, amount);\n        Account::deposit<TokenType>(account, token);\n    }\n...\n")),(0,o.kt)("p",null,"This completes the main logic of the game. It records the Game start time. Some more check functions can be added: for example, if bob doesn't bet at the specified time, then alice can terminate the game and get her bet back. Likewise, if alice fails to reveal her bet on time, it can be ruled that alice has lost."),(0,o.kt)("p",null,"How to write JS. See ",(0,o.kt)("inlineCode",{parentName:"p"},"SicBoGame.tsx")," in ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/Tonyce/starcoin-react-stepby"},"repo")),(0,o.kt)("h2",{id:"step-6---test-case"},"Step 6 - Test Case"),(0,o.kt)("p",null,'During the debugging process of the above game, a relatively "stupid" method was used to debug the sha3-256 result of the Move contract. It is to save the results of sha3-256 and compare them. In fact, it is more efficient to use unit-test (test cases) for this verification. Next a demo to show how to use test cases to verify Move sha3-256 results.'),(0,o.kt)("p",null,"To simply introduce test cases, create a new project"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"$ mpm package new move_ut\n")),(0,o.kt)("p",null,"Modify Move.toml and add starcoin's library."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-toml"},'...\n[addresses]\nStarcoinFramework = "0x1"\nadmin = "0xb80660f71e0d5ac2b5d5c43f2246403f"\nSFC = "0x6ee3f577c8da207830c31e1f0abb4244"\n\n[dependencies]\nStarcoinFramework = {git = "https://github.com/starcoinorg/starcoin-framework.git", rev="cf1deda180af40a8b3e26c0c7b548c4c290cd7e7"}\nstarcoin-framework-commons = { git = "https://github.com/starcoinorg/starcoin-framework-commons.git", rev = "e7f538175a5f50a97207692569b6631a87ee08cc" }\n...\n')),(0,o.kt)("p",null,"Create a new move file under source with any name. Copy the sample code from ",(0,o.kt)("a",{parentName:"p",href:"https://diem.github.io/move/unit-testing.html"},"https://diem.github.io/move/unit-testing.html"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-move"},"#[test_only]\nmodule admin::UTest {\n    struct MyCoin has key { value: u64 }\n\n    public fun make_sure_non_zero_coin(coin: MyCoin): MyCoin {\n        assert!(coin.value > 0, 0);\n        coins\n    }\n\n    public fun has_coin(addr: address): bool {\n        exists<MyCoin>(addr)\n    }\n\n    #[test]\n    fun make_sure_non_zero_coin_passes() {\n        let coin = MyCoin { value: 1 };\n        let MyCoin { value: _ } = make_sure_non_zero_coin(coin);\n    }\n}\n")),(0,o.kt)("p",null,"Then you will see the output of test after executing ",(0,o.kt)("inlineCode",{parentName:"p"},"mpm package test")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"\u276f mpm package test\nBUILDING UnitTest\nBUILDING StarcoinFramework\nBUILDING starcoin-framework-commons\nBUILDING move_ut\nRunning Move unit tests\n[ PASS ] 0xb80660f71e0d5ac2b5d5c43f2246403f::UTest::make_sure_non_zero_coin_passes\nTest result: OK. Total tests: 1; passed: 1; failed: 0\n")),(0,o.kt)("p",null,"This proves that the test case ran successfully. In this module, we add the ",(0,o.kt)("inlineCode",{parentName:"p"},"#[test_only]")," macro so that this module will not be compiled into release. If you execute ",(0,o.kt)("inlineCode",{parentName:"p"},"mpm release")," in this example project, you get:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"\u276f mpm release\nPackaging Modules:\nError: must at latest one module\n")),(0,o.kt)("p",null,"What we want to verify is the result of sha3-256, so modify the move code to"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-move"},'#[test_only]\nmodule admin::UTest {\n\n    use StarcoinFramework::Debug;\n    use StarcoinFramework::Vector;\n    use StarcoinFramework::Hash;\n\n    struct MyCoin has key { value: u64 }\n\n    public fun make_sure_non_zero_coin(coin: MyCoin): MyCoin {\n        assert!(coin.value > 0, 0);\n        coins\n    }\n\n    public fun has_coin(addr: address): bool {\n        exists<MyCoin>(addr)\n    }\n\n    #[test]\n    fun make_sure_non_zero_coin_passes() {\n        let coin = MyCoin { value: 1 };\n        let MyCoin { value: _ } = make_sure_non_zero_coin(coin);\n    }\n\n    #[test]\n    fun test_hash_result() {\n        let tempCamp = Vector::empty();\n        Vector::append(&mut tempCamp, b"hello world");\n        let camp = Hash::sha3_256(tempCamp);\n        Debug::print(&camp);\n    }\n}\n')),(0,o.kt)("p",null,"A new test function ",(0,o.kt)("inlineCode",{parentName:"p"},"test_hash_result"),' has been added, which does one thing: sha3-256("hello world"). First Debug and print it to see the result'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"\u276f mpm package test\nCACHED UnitTest\nCACHED StarcoinFramework\nCACHED starcoin-framework-commons\nBUILDING move_ut\nRunning Move unit tests\n[ PASS ] 0xb80660f71e0d5ac2b5d5c43f2246403f::UTest::make_sure_non_zero_coin_passes\n[debug] (&) [100, 75, 204, 126, 86, 67, 115, 4, 9, 153, 170, 200, 158, 118, 34, 243, 202, 113, 251, 161, 217, 114 , 253, 148, 163, 28, 59, 251, 242, 78, 57, 56]\n[ PASS ] 0xb80660f71e0d5ac2b5d5c43f2246403f::UTest::test_hash_result\nTest result: OK. Total tests: 2; passed: 2; failed: 0\n\nThis is the result of my execution of JS, which can be seen to be the same with the naked eye.\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"\u276f node sha3test.js\n{\n  type: 'Buffer',\n  data: [\n    100, 75, 204, 126, 86, 67, 115, 4,\n      9, 153, 170, 200, 158, 118, 34, 243,\n    202, 113, 251, 161, 217, 114, 253, 148,\n    163, 28, 59, 251, 242, 78, 57, 56\n  ]\n}\n")),(0,o.kt)("p",null,"But this is not enough, the assert result needs to be the same as the JS result. Modify ",(0,o.kt)("inlineCode",{parentName:"p"},"test_hash_result")," to"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-move"},'...\n    #[test]\n    fun test_hash_result() {\n        let expect_vec = vector[\n            100, 75, 204, 126, 86, 67, 115, 4,\n            9, 153, 170, 200, 158, 118, 34, 243,\n            202, 113, 251, 161, 217, 114, 253, 148,\n            163, 28, 59, 251, 242, 78, 57, 56\n        ];\n        let temp_camp = Vector::empty();\n        Vector::append(&mut temp_camp, b"hello world");\n        let camp = Hash::sha3_256(temp_camp);\n        Debug::print(&camp);\n        assert!(&camp == &expect_vec, 1);\n    }\n')),(0,o.kt)("p",null,"then execute"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"\u276f mpm package test\nCACHED UnitTest\nCACHED StarcoinFramework\nCACHED starcoin-framework-commons\nBUILDING move_ut\nRunning Move unit tests\n[ PASS ] 0xb80660f71e0d5ac2b5d5c43f2246403f::UTest::make_sure_non_zero_coin_passes\n[debug] (&) [100, 75, 204, 126, 86, 67, 115, 4, 9, 153, 170, 200, 158, 118, 34, 243, 202, 113, 251, 161, 217, 114 , 253, 148, 163, 28, 59, 251, 242, 78, 57, 56]\n[ PASS ] 0xb80660f71e0d5ac2b5d5c43f2246403f::UTest::test_hash_result\nTest result: OK. Total tests: 2; passed: 2; failed: 0\n")),(0,o.kt)("p",null,"As you can see, there is no problem. If you doubt the assert, you can modify one of the data in ",(0,o.kt)("inlineCode",{parentName:"p"},"expect_vec")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"mpm package test")," again. Then you will find:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"..\n[debug] (&) [100, 75, 204, 126, 86, 67, 115, 4, 9, 153, 170, 200, 158, 118, 34, 243, 202, 113, 251, 161, 217, 114, 253, 148, 163, 28, 59, 251, 242, 78, 57, 56]\n[ FAIL    ] 0xb80660f71e0d5ac2b5d5c43f2246403f::UTest::test_hash_result\n\nTest failures:\n\nFailures in 0xb80660f71e0d5ac2b5d5c43f2246403f::UTest:\n\n\u250c\u2500\u2500 test_hash_result \u2500\u2500\u2500\u2500\u2500\u2500\n\u2502 error[E11001]: test failure\n\u2502    \u250c\u2500 ./sources/ut.move:41:9\n\u2502    \u2502\n\u2502 30 \u2502     fun test_hash_result() {\n\u2502    \u2502         ---------------- In this function in 0xb80660f71e0d5ac2b5d5c43f2246403f::UTest\n\u2502    \xb7\n\u2502 41 \u2502         assert!(&camp == &expect_vec, 1);\n\u2502    \u2502         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ Test was not expected to abort but it aborted with 1 here\n\u2502 \n\u2502 \n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nTest result: FAILED. Total tests: 2; passed: 1; failed: 1\n")),(0,o.kt)("p",null,"The test case does not pass. Perfect."),(0,o.kt)("p",null,"Test cases can not only ensure the quality of the program, but also greatly improve the efficiency."),(0,o.kt)("h2",{id:"refinement-plan"},"Refinement plan"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"The cookbook is used as a manual, if you have any problems, go to see it."),(0,o.kt)("li",{parentName:"ol"},"Common methods of move contract."),(0,o.kt)("li",{parentName:"ol"},". . .")))}p.isMDXComponent=!0}}]);